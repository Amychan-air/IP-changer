<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CentOS/RHEL 靜態 IP 命令生成器（nmcli）</title>
  <style>
    body { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 24px; line-height: 1.5; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    .row { margin-bottom: 12px; }
    label { display: block; font-weight: 600; margin-bottom: 4px; }
    input, textarea, select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    textarea { min-height: 120px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .inline { display: flex; gap: 12px; }
    .inline .col { flex: 1; }
    button { padding: 8px 12px; border: 1px solid #999; background: #111; color: #fff; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #f5f5f5; color: #111; border-color: #ccc; }
    .muted { color: #666; font-size: 12px; }
    pre { background: #0b1020; color: #d1e7ff; padding: 12px; border-radius: 8px; overflow: auto; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
  <meta name="description" content="在 CentOS 7–9（RHEL/Alma/Rocky）用 nmcli 生成設定靜態 IPv4、預設閘道與 DNS 的命令。">
</head>
<body>
  <h1>CentOS 7–9（RHEL/Alma/Rocky）靜態 IP 命令生成器</h1>

  <div class="muted">輸入 IPv4、前綴（CIDR）、預設閘道與 DNS，生成永久生效的 nmcli 命令與可選的臨時指令。</div>

  <div class="inline row">
    <div class="col">
      <label for="iface">網卡名稱（interface，如 eth0、ens160）</label>
      <input id="iface" type="text" placeholder="例如：ens160 或 eth0">
      <div class="muted">可用 <code>nmcli dev status</code> 查詢。</div>
    </div>
    <div class="col">
      <label for="conn">連線名稱（connection，可留空）</label>
      <input id="conn" type="text" placeholder="預設會使用 System &lt;interface&gt;">
      <div class="muted">可用 <code>nmcli con show</code> 查詢。</div>
    </div>
  </div>

  <div class="inline row">
    <div class="col">
      <label for="cidr">前綴長度（CIDR，如 24、29、30）</label>
      <input id="cidr" type="number" min="1" max="32" value="24">
    </div>
    <div class="col">
      <label for="gateway">預設閘道（gateway）</label>
      <input id="gateway" type="text" placeholder="例如：192.168.1.1">
    </div>
  </div>

  <div class="row">
    <label for="ips">IPv4 位址（每行一個；支援最後段範圍，如 111.68.11.194-222；不含前綴）</label>
    <textarea id="ips" placeholder="例如：
192.168.1.50
192.168.1.60-80"></textarea>
  </div>

  <div class="row">
    <label for="dns">DNS 伺服器（以空格或換行分隔）</label>
    <textarea id="dns" placeholder="例如：
8.8.8.8 1.1.1.1"></textarea>
  </div>

  <div class="inline row">
    <button id="generate">生成命令</button>
    <button id="copy" class="secondary">複製命令</button>
  </div>

  <div class="row">
    <label>輸出</label>
    <pre><code id="output" spellcheck="false"></code></pre>
  </div>

  <script>
    function isValidIp(ip) {
      const parts = ip.trim().split('.')
      if (parts.length !== 4) return false
      return parts.every(p => {
        if (!/^\d+$/.test(p)) return false
        const n = Number(p)
        return n >= 0 && n <= 255
      })
    }

    function parseList(text) {
      return text
        .split(/\r?\n|\s+/)
        .map(s => s.trim())
        .filter(s => s.length > 0)
    }

    function uniqueKeepOrder(arr) {
      const seen = new Set()
      const out = []
      for (const v of arr) {
        if (!seen.has(v)) { seen.add(v); out.push(v) }
      }
      return out
    }

    function expandIpOrRange(token) {
      const s = token.trim()
      if (isValidIp(s)) return [s]
      const m = s.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})-(\d{1,3})$/)
      if (!m) return []
      const a = Number(m[1])
      const b = Number(m[2])
      const c = Number(m[3])
      const start = Number(m[4])
      const end = Number(m[5])
      const inRange = (n) => n >= 0 && n <= 255
      if (![a, b, c, start, end].every(inRange)) return []
      if (end < start) return []
      const ips = []
      for (let i = start; i <= end; i++) {
        ips.push(`${a}.${b}.${c}.${i}`)
      }
      return ips
    }

    function expandIpList(text) {
      const tokens = parseList(text)
      const out = []
      for (const t of tokens) {
        const expanded = expandIpOrRange(t)
        for (const ip of expanded) out.push(ip)
      }
      return out
    }

    function buildNmcli(ipList, cidr, gateway, iface, conn, dnsList) {
      const lines = []
      const connectionName = conn || (iface ? `System ${iface}` : 'YOUR_CONNECTION_NAME')

      lines.push(`# 永久設定（重啟後仍生效）`)
      if (!conn) {
        lines.push(`# 如連線名稱不同，請以 nmcli con show 查詢後替換。`)
      }
      lines.push(`nmcli con mod "${connectionName}" ipv4.addresses ${ipList[0]}/${cidr}`)
      for (let i = 1; i < ipList.length; i++) {
        lines.push(`nmcli con mod "${connectionName}" +ipv4.addresses ${ipList[i]}/${cidr}`)
      }
      lines.push(`nmcli con mod "${connectionName}" ipv4.gateway ${gateway}`)
      if (dnsList.length > 0) {
        const dnsJoined = dnsList.join(' ')
        lines.push(`nmcli con mod "${connectionName}" ipv4.dns "${dnsJoined}"`)
      }
      lines.push(`nmcli con mod "${connectionName}" ipv4.method manual`)
      lines.push(`nmcli con mod "${connectionName}" connection.autoconnect yes`)
      lines.push(`nmcli con up "${connectionName}"`)

      lines.push('')
      lines.push(`# 驗證`)
      lines.push(`ip a`)
      lines.push(`ip r`)
      lines.push(`nmcli dev show ${iface || '<YOUR_IFACE>'} | grep -i dns`)
      lines.push(`cat /etc/resolv.conf`)

      lines.push('')
      lines.push(`# 臨時設定（重啟或介面重啟後失效）`)
      if (iface) {
        for (const ip of ipList) {
          lines.push(`ip addr add ${ip}/${cidr} dev ${iface}`)
        }
        lines.push(`ip route replace default via ${gateway} dev ${iface}`)
      } else {
        lines.push(`# 缺少介面名稱，請替換下面的 <YOUR_IFACE>`)
        for (const ip of ipList) {
          lines.push(`ip addr add ${ip}/${cidr} dev <YOUR_IFACE>`)
        }
        lines.push(`ip route replace default via ${gateway} dev <YOUR_IFACE>`)
      }
      if (dnsList.length > 0) {
        const resolv = dnsList.map(d => `nameserver ${d}`).join("\\n")
        lines.push(`printf "${resolv}\\n" > /etc/resolv.conf`)
      }

      return lines.join('\n')
    }

    function generate() {
      const iface = document.getElementById('iface').value.trim()
      const conn = document.getElementById('conn').value.trim()
      const cidr = Number(document.getElementById('cidr').value || 24)
      const gateway = document.getElementById('gateway').value.trim()
      const ipsRaw = document.getElementById('ips').value
      const dnsRaw = document.getElementById('dns').value

      if (!(cidr >= 1 && cidr <= 32)) {
        alert('CIDR 前綴長度需介於 1-32。')
        return
      }

      const ipList = uniqueKeepOrder(expandIpList(ipsRaw))
      if (ipList.length === 0) {
        alert('請至少輸入一個有效 IPv4 位址或範圍（例如 111.68.11.194-222）。')
        return
      }
      if (!isValidIp(gateway)) {
        alert('請輸入有效的預設閘道（IPv4）。')
        return
      }

      const dnsList = uniqueKeepOrder(parseList(dnsRaw).filter(isValidIp))

      const out = buildNmcli(ipList, cidr, gateway, iface, conn, dnsList)
      document.getElementById('output').textContent = out
    }

    document.getElementById('generate').addEventListener('click', generate)
    document.getElementById('copy').addEventListener('click', async () => {
      const text = document.getElementById('output').textContent
      if (!text) return
      try {
        await navigator.clipboard.writeText(text)
        alert('已複製到剪貼簿！')
      } catch (e) {
        const ta = document.createElement('textarea')
        ta.value = text
        document.body.appendChild(ta)
        ta.select()
        document.execCommand('copy')
        document.body.removeChild(ta)
        alert('已複製到剪貼簿！')
      }
    })
  </script>
</body>
</html>


