<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Netplan YAML 生成器</title>
  <style>
    body { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 24px; line-height: 1.5; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    .row { margin-bottom: 12px; }
    label { display: block; font-weight: 600; margin-bottom: 4px; }
    input, textarea, select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    textarea { min-height: 120px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .inline { display: flex; gap: 12px; }
    .inline .col { flex: 1; }
    button { padding: 8px 12px; border: 1px solid #999; background: #111; color: #fff; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #f5f5f5; color: #111; border-color: #ccc; }
    .muted { color: #666; font-size: 12px; }
    pre { background: #0b1020; color: #d1e7ff; padding: 12px; border-radius: 8px; overflow: auto; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <h1>Netplan YAML 生成器</h1>

  <div class="row">
    <label for="ipRanges">輸入 IP 範圍（每行一組，格式：起始IP-結束最後八位或完整結束IP）</label>
    <textarea id="ipRanges" placeholder="例如：\n52.128.237.2-30\n52.128.237.34-62\n52.128.237.66-94\n52.128.237.98-126"></textarea>
    <div class="muted">支援如 52.128.237.2-30（同一個 /24）或 52.128.237.2-52.128.237.30（完整結束 IP）。</div>
  </div>

  <div class="inline row">
    <div class="col">
      <label for="cidr">前綴長度（CIDR，如 29、30、24）</label>
      <input id="cidr" type="number" min="1" max="32" value="29">
    </div>
    <div class="col">
      <label for="gateway">預設閘道（via）</label>
      <input id="gateway" type="text" placeholder="例如：112.121.175.214" value="112.121.175.214">
    </div>
    <div class="col">
      <label for="interface">網卡名稱（可選）</label>
      <input id="interface" type="text" placeholder="例如：ens160 或 eth0">
    </div>
    <div class="col">
      <label for="hyphenIndent">列表項縮排空格數（- 前）</label>
      <input id="hyphenIndent" type="number" min="0" max="32" value="8">
      <div class="muted">例如 8 代表在 '-' 前有 8 個空格。</div>
    </div>
  </div>

  <div class="inline row">
    <button id="generate">生成 YAML</button>
    <button id="copy" class="secondary">複製 YAML</button>
  </div>

  <div class="row">
    <label>輸出</label>
    <pre><code id="output" spellcheck="false"></code></pre>
  </div>

  <script>
    function isValidIp(ip) {
      const parts = ip.trim().split('.')
      if (parts.length !== 4) return false
      return parts.every(p => {
        if (!/^\d+$/.test(p)) return false
        const n = Number(p)
        return n >= 0 && n <= 255
      })
    }

    function parseIp(ip) {
      return ip.split('.').map(n => Number(n))
    }

    function expandRange(line) {
      // 支援兩種格式：
      // 1) A.B.C.X-Y（僅最後八位）
      // 2) A.B.C.X-A.B.C.Y（完整結束IP）
      const raw = line.trim()
      if (!raw) return []

      // 嘗試完整結束 IP 格式
      const matchFull = raw.match(/^\s*(\d+\.\d+\.\d+\.\d+)\s*-\s*(\d+\.\d+\.\d+\.\d+)\s*$/)
      if (matchFull) {
        const start = matchFull[1]
        const end = matchFull[2]
        if (!isValidIp(start) || !isValidIp(end)) return []
        const s = parseIp(start)
        const e = parseIp(end)
        // 僅支援同 /24 的連續範圍
        if (s[0] !== e[0] || s[1] !== e[1] || s[2] !== e[2]) return []
        const ips = []
        for (let last = s[3]; last <= e[3]; last++) {
          ips.push(`${s[0]}.${s[1]}.${s[2]}.${last}`)
        }
        return ips
      }

      // 嘗試最後八位格式
      const matchLast = raw.match(/^(\d+\.\d+\.\d+)\.(\d+)\s*-\s*(\d+)$/)
      if (matchLast) {
        const base = matchLast[1]
        const startLast = Number(matchLast[2])
        const endLast = Number(matchLast[3])
        if (startLast > endLast) return []
        const ips = []
        for (let last = startLast; last <= endLast; last++) {
          const ip = `${base}.${last}`
          if (isValidIp(ip)) ips.push(ip)
        }
        return ips
      }

      // 單一 IP
      if (isValidIp(raw)) return [raw]

      return []
    }

    function uniqueKeepOrder(arr) {
      const seen = new Set()
      const out = []
      for (const v of arr) {
        if (!seen.has(v)) { seen.add(v); out.push(v) }
      }
      return out
    }

    function buildYaml(addresses, cidr, gateway, iface, hyphenIndentUser) {
      const indent = (n) => ' '.repeat(n)

      if (!iface) {
        const lines = []
        const parentAddr = 2
        const parentRoutes = 2
        const hyphenAddr = Math.max(Number(hyphenIndentUser) || 0, parentAddr + 2)
        const hyphenRoutes = Math.max(Number(hyphenIndentUser) || 0, parentRoutes + 2)

        lines.push(`dhcp4: false`)
        lines.push(`${indent(parentAddr)}addresses:`)
        for (const ip of addresses) {
          lines.push(`${indent(hyphenAddr)}- ${ip}/${cidr}`)
        }
        lines.push(`${indent(parentRoutes)}routes:`)
        lines.push(`${indent(hyphenRoutes)}- to: default`)
        lines.push(`${indent(hyphenRoutes + 2)}via: ${gateway}`)
        return lines.join('\n')
      }

      // 完整 netplan（適用 Ubuntu 22.04）
      const lines = []
      const parentAddr = 6
      const parentRoutes = 6
      const hyphenAddr = Math.max(Number(hyphenIndentUser) || 0, parentAddr + 2)
      const hyphenRoutes = Math.max(Number(hyphenIndentUser) || 0, parentRoutes + 2)

      lines.push(`network:`)
      lines.push(`${indent(2)}version: 2`)
      lines.push(`${indent(2)}ethernets:`)
      lines.push(`${indent(4)}${iface}:`)
      lines.push(`${indent(6)}dhcp4: false`)
      lines.push(`${indent(6)}addresses:`)
      for (const ip of addresses) {
        lines.push(`${indent(hyphenAddr)}- ${ip}/${cidr}`)
      }
      lines.push(`${indent(6)}routes:`)
      lines.push(`${indent(hyphenRoutes)}- to: default`)
      lines.push(`${indent(hyphenRoutes + 2)}via: ${gateway}`)
      return lines.join('\n')
    }

    function generate() {
      const input = document.getElementById('ipRanges').value.split(/\r?\n/)
      const cidr = Number(document.getElementById('cidr').value || 29)
      const gateway = document.getElementById('gateway').value.trim()
      const iface = document.getElementById('interface').value.trim()
      const hyphenIndent = Number(document.getElementById('hyphenIndent').value || 8)

      if (!gateway) {
        alert('請輸入預設閘道（via）。')
        return
      }
      if (!(cidr >= 1 && cidr <= 32)) {
        alert('CIDR 前綴長度需介於 1-32。')
        return
      }
      if (!(hyphenIndent >= 0 && hyphenIndent <= 64)) {
        alert("'-' 前空格數需介於 0-64。")
        return
      }

      let all = []
      for (const line of input) {
        const expanded = expandRange(line)
        all = all.concat(expanded)
      }
      const addresses = uniqueKeepOrder(all)
      if (addresses.length === 0) {
        alert('未解析到任何有效 IP。請檢查輸入格式。')
        return
      }

      const yaml = buildYaml(addresses, cidr, gateway, iface, hyphenIndent)
      document.getElementById('output').textContent = yaml
    }

    document.getElementById('generate').addEventListener('click', generate)
    document.getElementById('copy').addEventListener('click', async () => {
      const text = document.getElementById('output').textContent
      if (!text) return
      try {
        await navigator.clipboard.writeText(text)
        alert('已複製到剪貼簿！')
      } catch (e) {
        const ta = document.createElement('textarea')
        ta.value = text
        document.body.appendChild(ta)
        ta.select()
        document.execCommand('copy')
        document.body.removeChild(ta)
        alert('已複製到剪貼簿！')
      }
    })
  </script>
</body>
</html>
