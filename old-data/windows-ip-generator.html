<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Windows 靜態 IP 命令生成器（PowerShell）</title>
  <style>
    body { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 24px; line-height: 1.5; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    .row { margin-bottom: 12px; }
    label { display: block; font-weight: 600; margin-bottom: 4px; }
    input, textarea, select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    textarea { min-height: 120px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .inline { display: flex; gap: 12px; }
    .inline .col { flex: 1; }
    button { padding: 8px 12px; border: 1px solid #999; background: #111; color: #fff; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #f5f5f5; color: #111; border-color: #ccc; }
    .muted { color: #666; font-size: 12px; }
    pre { background: #0b1020; color: #d1e7ff; padding: 12px; border-radius: 8px; overflow: auto; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
  <meta name="description" content="在 Windows 以 PowerShell 生成設定靜態 IPv4、預設閘道與 DNS 的命令。">
  <meta name="color-scheme" content="light dark">
  <meta name="supported-color-schemes" content="light dark">
  <meta name="robots" content="noindex">
  <meta name="referrer" content="no-referrer">
  <meta name="x-ua-compatible" content="IE=edge">
</head>
<body>
  <h1>Windows 靜態 IP 命令生成器（PowerShell）</h1>

  <div class="muted">輸入 IPv4/CIDR、預設閘道與 DNS，生成永久生效的 PowerShell 指令。預設會略過第一個可用位址，僅為其餘可用位址新增 IP（例如 148.66.20.88/29 會輸出 148.66.20.90–94）。</div>

  <div class="inline row">
    <div class="col">
      <label for="alias">介面名稱（InterfaceAlias，如 Ethernet）</label>
      <input id="alias" type="text" placeholder="例如：Ethernet">
      <div class="muted">可用 <code>Get-NetAdapter | Select-Object -Expand Name</code> 查詢。</div>
    </div>
    <div class="col">
      <label for="cidr">IPv4/CIDR（如 148.66.20.88/29）</label>
      <input id="cidr" type="text" placeholder="例如：148.66.20.88/29">
    </div>
  </div>

  <div class="inline row">
    <div class="col">
      <label for="gateway">預設閘道（gateway）</label>
      <input id="gateway" type="text" placeholder="例如：192.168.1.1">
    </div>
    <div class="col">
      <label for="dns">DNS 伺服器（以空格或換行分隔）</label>
      <textarea id="dns" placeholder="例如：
8.8.8.8 1.1.1.1"></textarea>
    </div>
  </div>

  <div class="inline row">
    <button id="generate">生成命令</button>
    <button id="copy" class="secondary">複製命令</button>
  </div>

  <div class="row">
    <label>輸出</label>
    <pre><code id="output" spellcheck="false"></code></pre>
  </div>

  <script>
    function isValidIp(ip) {
      const parts = ip.trim().split('.')
      if (parts.length !== 4) return false
      return parts.every(p => {
        if (!/^\d+$/.test(p)) return false
        const n = Number(p)
        return n >= 0 && n <= 255
      })
    }

    function parseList(text) {
      return text
        .split(/\r?\n|\s+/)
        .map(s => s.trim())
        .filter(s => s.length > 0)
    }

    function uniqueKeepOrder(arr) {
      const seen = new Set()
      const out = []
      for (const v of arr) {
        if (!seen.has(v)) { seen.add(v); out.push(v) }
      }
      return out
    }

    function ipToInt(ip) {
      const p = ip.split('.').map(Number)
      return ((p[0] << 24) >>> 0) + (p[1] << 16) + (p[2] << 8) + p[3]
    }

    function intToIp(n) {
      const a = (n >>> 24) & 255
      const b = (n >>> 16) & 255
      const c = (n >>> 8) & 255
      const d = n & 255
      return `${a}.${b}.${c}.${d}`
    }

    function maskFromPrefix(prefix) {
      if (!(prefix >= 0 && prefix <= 32)) return null
      return prefix === 0 ? 0 : (0xffffffff << (32 - prefix)) >>> 0
    }

    function parseCidr(cidrText) {
      const s = (cidrText || '').trim()
      const m = s.match(/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\/(\d{1,2})$/)
      if (!m) return null
      const ip = m[1]
      const prefix = Number(m[2])
      if (!isValidIp(ip)) return null
      if (!(prefix >= 0 && prefix <= 32)) return null
      return { ip, prefix }
    }

    function computeUsableIps(ip, prefix) {
      const ipInt = ipToInt(ip)
      const mask = maskFromPrefix(prefix)
      if (mask === null) return []
      const network = (ipInt & mask) >>> 0
      const size = 2 ** (32 - prefix)
      const broadcast = (network + size - 1) >>> 0

      let start, end
      if (prefix === 32) { start = network; end = network }
      else if (prefix === 31) { start = network; end = broadcast }
      else { start = network + 1; end = broadcast - 1 }

      const out = []
      for (let n = start >>> 0; n <= (end >>> 0); n = (n + 1) >>> 0) {
        out.push(intToIp(n))
        if (n === 0xffffffff) break
      }
      return out
    }

    function buildPowershell(ipsToAdd, prefix, alias, gateway, dnsList, meta) {
      const lines = []
      lines.push(`# 永久設定（請在 PowerShell 以系統管理員執行）`)
      if (!alias) {
        lines.push(`# 缺少介面名稱，請替換下方的 <YOUR_ALIAS> 再執行。`)
      }
      if (meta && meta.usableRange) {
        lines.push(`# 可用位址範圍：${meta.usableRange}`)
        lines.push(`# 預設略過第一個可用位址，僅新增其餘位址。`)
      }

      const interfaceAlias = alias || '<YOUR_ALIAS>'

      for (const ip of ipsToAdd) {
        lines.push(`New-NetIPAddress -InterfaceAlias "${interfaceAlias}" -IPAddress ${ip} -PrefixLength ${prefix} -Type Unicast -SkipAsSource $true`)
      }

      if (isValidIp(gateway)) {
        lines.push(`New-NetRoute -DestinationPrefix 0.0.0.0/0 -InterfaceAlias "${interfaceAlias}" -NextHop ${gateway}`)
      }

      if (dnsList.length > 0) {
        const dnsJoined = dnsList.join(' ')
        lines.push(`Set-DnsClientServerAddress -InterfaceAlias "${interfaceAlias}" -ServerAddresses ${dnsJoined}`)
      }

      lines.push('')
      lines.push('# 驗證')
      lines.push(`Get-NetIPAddress -InterfaceAlias "${interfaceAlias}" | Format-Table IPAddress,PrefixLength,AddressState,SkipAsSource`)
      lines.push(`Get-NetRoute -InterfaceAlias "${interfaceAlias}" | Where-Object DestinationPrefix -eq "0.0.0.0/0"`)
      lines.push(`Get-DnsClientServerAddress -InterfaceAlias "${interfaceAlias}"`)

      return lines.join('\n')
    }

    function generate() {
      const alias = document.getElementById('alias').value.trim()
      const cidrText = document.getElementById('cidr').value.trim()
      const gateway = document.getElementById('gateway').value.trim()
      const dnsRaw = document.getElementById('dns').value

      const parsed = parseCidr(cidrText)
      if (!parsed) {
        alert('請輸入有效的 IPv4/CIDR，例如 148.66.20.88/29。')
        return
      }
      const { ip, prefix } = parsed

      if (gateway && !isValidIp(gateway)) {
        alert('請輸入有效的預設閘道（IPv4）。')
        return
      }

      const dnsList = uniqueKeepOrder(parseList(dnsRaw).filter(isValidIp))

      const usable = computeUsableIps(ip, prefix)
      if (usable.length === 0) {
        alert('無可用主機位址，請調整前綴長度。')
        return
      }

      const ipsToAdd = usable.slice(Math.min(1, usable.length))

      const meta = { usableRange: `${usable[0]}-${usable[usable.length - 1]}` }
      const out = buildPowershell(ipsToAdd, prefix, alias, gateway, dnsList, meta)
      document.getElementById('output').textContent = out
    }

    document.getElementById('generate').addEventListener('click', generate)
    document.getElementById('copy').addEventListener('click', async () => {
      const text = document.getElementById('output').textContent
      if (!text) return
      try {
        await navigator.clipboard.writeText(text)
        alert('已複製到剪貼簿！')
      } catch (e) {
        const ta = document.createElement('textarea')
        ta.value = text
        document.body.appendChild(ta)
        ta.select()
        document.execCommand('copy')
        document.body.removeChild(ta)
        alert('已複製到剪貼簿！')
      }
    })
  </script>
</body>
</html>


